
- [域名系统DNS](#域名系统dns)
    - [DNS工作过程](#dns工作过程)
- [动态主机配置协议DHCP](#动态主机配置协议dhcp)
    - [DHCP工作工程](#dhcp工作工程)
- [文件传输协议FTP](#文件传输协议ftp)
- [远程登录协议TELENT](#远程登录协议telent)
- [电子邮件协议](#电子邮件协议)
    - [邮件发送协议SMTP](#邮件发送协议smtp)
    - [邮件接收协议POP和IMAP](#邮件接收协议pop和imap)
    - [基于万维网的电子邮件](#基于万维网的电子邮件)
- [常用端口](#常用端口)
- [Web页面请求过程](#web页面请求过程)
    - [1.DHCP配置主机信息](#1dhcp配置主机信息)
    - [2.DNS和ARP](#2dns和arp)
    - [3.域内路由选择到DNS服务器](#3域内路由选择到dns服务器)
    - [4.HTTP请求页面](#4http请求页面)

## 域名系统DNS  
DNS 是一个通过分层服务器实现的分布式数据库，**提供了主机名和 IP 地址之间相互转换的服务**。这里的分布式数据库是指，每个站点只保留与它相关的那部分数据。

DNS可以使用UDP或者TCP进行传输，使用的端口号都为 53。**大多数情况下DNS使用UDP进行传输**，这就要求域名解析器和域名服务器都必须自己处理超时和重传从而保证可靠性。**在两种情况下会使用TCP进行传输**：
- 如果返回的响应超过的 512 字节（UDP 最大只支持512字节的数据）。
- 区域传送（区域传送是主域名服务器向辅助域名服务器传送变化的那部分数据）。

**域名层次结构**从上到下依次为：根域名、顶级域名、二级域名：  
![域名结构](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/%E5%9F%9F%E5%90%8D%E7%BB%93%E6%9E%84.png)

**域名服务器层次结构**:
为了处理扩展性问题，DNS系统使用了大量的DNS服务器。与域名系统一样，域名服务器也是采用层次结构   
![DNS服务器](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8.png)
- **根域名服务器**：是最重要的域名服务器。所有的根域名服务器都知道所有的顶级域名服务器的域名和 IP 地址。不管是哪一个本地域名服务器，若要对因特网上任何一个域名进行解析，只要自己无法解析，就首先求助于根域名服务器。

- **顶级域名服务器**：负责管理在该顶级域名服务器注册的所有二级域名，如com net org edu等。

- **权限域名服务器**:在因特网上具有公共可访问主机的每个组织机构必须提供公共可访问的DNS记录，权限DNS服务器收藏这些记录。
不能给出最后的查询回答时，就会告诉发出查询请求的 DNS 客户，下一步应当找哪一个权限域名服务器。

另外还有一种域名服务器**本地域名服务器**(严格来说，不属于服务器中的层次结构)对域名系统非常重要。   当一个主机发出 DNS 查询请求时，这个查询请求报文就发送给本地域名服务器。每一个因特网服务提供者 ISP，或一个大学，甚至一个大学里的系，都可以拥有一个本地域名服务器，这种域名服务器有时也称为**默认域名服务器**。

### DNS工作过程
![DNS工作过程](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/DNS%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B.png)
假设主机cis.poly.edu想知道主机gaia.cs.umass.edu的ip地址，本地DNS服务器为dns.poly.edu并且gaia.cs.uass.edu的权限服务器为dns.umass.edu如上图所示
1. 主机cis.poly.edu首先向它的本地DNS服务器发送一个DNS查询报文。报文中含有被转换域名/gaia.cs.umass.edu 
2. 本地DNS服务器将该报文转发到根DNS服务器
3. 根DNS服务器注意到其edu后缀并向本地DNS服务器返回负责edu的顶级域名服务器的IP列表
4. 本地DNS服务器再次向顶级域名服务器之一发送查询报文。
5. 该顶级域名服务器发现umass后缀，使用管理umass的权限DNS服务器的IP地址响应。
6. 本地DNS服务器直接向dns.umass.edu重发查询报文，
7.  dns.umass.edu用gaua.cs.umass.edu的IP地址进行响应。
8. 本地DNS服务器返回给主机要转换的IP地址


注意到，一次查询发送了8个DNS报文，实际上为了减少在因特网上到处传输的DNS报文数量，每个域名服务器都维护一个高速缓存（**DNS缓存**），存放最近用过的名字以及从何处获得名字映射信息的记录。

另外，DNS 域名服务器都把数据复制到几个域名服务器来保存，其中的一个是**主域名服务器**，其他的是**辅助域名服务器**。当主域名服务器出故障时，辅助域名服务器可以保证 DNS 的查询工作不会中断。**主域名服务器定期把数据复制到辅助域名服务器中，而更改数据只能在主域名服务器中进行。这样就保证了数据的一致性**。

## 动态主机配置协议DHCP
连接到因特网的计算机的协议软件需要配置的项目包括：
1. **IP地址**
2. **子网掩码**
3. **默认路由器的IP地址**
4. **域名服务器的IP地址**

这些信息通常存储在一个配置文件中，计算机可以对这个文件进行存取。使用人工配置既不方便，又容易出错，现在广泛使用的是动态主机配置协议DHCP（Dynamic Host Configuration Protocol）。

**DHCP使用UDP协议工作**

**DHCP 提供了即插即用连网(plug-and-playnetworking)的机制。这种机制允许一台计算机加入新的网络和获取IP地址而不用手工参与**。

### DHCP工作工程
![DHCP工作过程](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/DHCP%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B.png)
1. 需要IP地址的客户端在启动时发送 Discover 报文，该报文的目的地址为 255.255.255.255:67，源地址为 0.0.0.0:68，被放入 UDP 中，该报文被**广播**到同一个子网的所有主机上。如果客户端和 DHCP 服务器不在同一个子网，就需要使用中继代理，中继代理收到主机发送的发现报文后，以单播方式向DHCP服务器转发此报文。
2. DHCP 服务器收到 Discover 报文之后，发送 Offer 报文给客户端，该报文包含了客户端所需要的信息。因为客户端可能收到多个 DHCP 服务器提供的信息，因此客户端需要进行选择。
3. 如果客户端选择了某个 DHCP 服务器提供的信息，那么就发送 Request 报文给该 DHCP 服务器。
4. DHCP 服务器发送 Ack 报文，表示客户端此时可以使用提供给它的信息。

DHCP 服务器分配给 DHCP 客户的 IP 地址的**临时的**，因此 DHCP 客户只能在一段有限的时间内使用这个分配到的IP 地址。DHCP 协议称这段时间为**租用期**。租用期的数值应由 DHCP 服务器自己决定。DHCP 客户也可在自己发送的报文中（例如，发现报文）提出对租用期的要求。

## 文件传输协议FTP
文件传送协议FTP是因特网上使用最广泛的文件传送协议，它的主要功能是减少或消除在不同操作系统下处理文件的不兼容性。

**FTP使用 TCP 进行连接，它需要两个连接来传送一个文件**：
1. **控制连接**：用于在两主机之间传输控制信息，如用户标识、口令、改变远程目录的命令等。在整个会话过程中一直打开
2. **数据连接**：用来实际传送一个文件数据。

当客户进程向服务器进程发出建立连接请求时，要寻找连接服务器进程的熟知端口(21)，同时还要告诉服务器进程自己的另一个端口号码，用于建立数据传送连接。接着，服务器进程用自己传送数据的熟知端口(20)与客户进程所提供的端口号码建立数据传送连接。由于 FTP 使用了两个不同的端口号，所以数据连接与控制连接不会发生混乱。



FTP 使用**客户服务器方式**。一个 FTP 服务器进程可同时为多个客户进程提供服务。FTP 的服务器进程由两大部分组成：**一个主进程，负责接受新的请求；另外有若干个从属进程，负责处理单个请求**。

主进程的工作步骤如下：
1. 打开熟知端口（端口号为 21），使客户进程能够连接上。
2. 等待客户进程发出连接请求。
3. 启动从属进程来处理客户进程发来的请求。从属进程对客户进程的请求处理完毕后即终止，但从属进程在运行期间根据需要还可能创建其他一些子进程。
4. 回到等待状态，继续接受其他客户进程发来的请求。主进程与从属进程的处理是并发地进行。
## 远程登录协议TELENT
TELNET 是一个简单的远程终端协议。用户用 TELNET 就可在其所在地通过TCP连接注册（即登录）到远地的另一个主机上（使用主机名或 IP 地址）。

TELNET 也使用**客户服务器**方式。在本地系统运行 TELNET 客户进程，而在远地主机则运行 TELNET 服务器进程。和 FTP 的情况相似，服务器中的主进程等待新的请求，并产生从属进程来处理每一个连接。

TELNET定义了数据和命令应怎样通过因特网，这些定义就是所谓的**网络虚拟终端NVT**（Network Virtual Terminal）。
![TELNET](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/TELNET.png)
客户软件把用户的击键和命令转换成 NVT 格式，并送交服务器。

服务器软件把收到的数据和命令，从 NVT 格式转换成远地系统所需的格式。

向用户返回数据时，服务器把远地系统的格式转换为 NVT 格式，本地客户再从 NVT 格式转换到本地系统所需的格式。
## 电子邮件协议
一个电子邮件系统应具有三个主要组成部分：**用户代理**、**邮件服务器**、**邮件发送协议（如SMTP）与邮件读取协议（如POP）**。
![邮件系统](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/%E9%82%AE%E4%BB%B6%E7%B3%BB%E7%BB%9F.png)

用户代理（User Agent）就是用户与电子邮件系统的接口，在大多数情况下它就是运行在用户PC机中的一个程序。一般具有撰写、显示、处理、通信等功能。

邮件服务器的功能是发送和接收邮件，同时还要向发信人报告邮件传送的情况（已交付、被拒绝、丢失等）。邮件服务器按照客户服务器方式工作。邮件服务器需要使用发送和读取两个不同的协议。

发送和接收电子邮件的几个重要步骤：
1. 发件人调用 PC 中的用户代理撰写和编辑要发送的邮件。
2. 发件人的用户代理把邮件用SMTP 协议发给发送方邮件服务器，
3. SMTP 服务器把邮件临时存放在邮件缓存队列中，等待发送。
4. 发送方邮件服务器的SMTP 客户与接收方邮件服务器的 SMTP 服务器建立 TCP 连接，然后就把邮件缓存队列中的邮件依次发送出去
5. 运行在接收方邮件服务器中的SMTP服务器进程收到邮件后，把邮件放入收件人的用户邮箱中，等待收件人进行读取。
6. 收件人在打算收信时，就运行 PC 机中的用户代理，使用 POP3（或 IMAP）协议读取发送给自己的邮件。请注意，POP3 服务器和 POP3 客户之间的通信是由 POP3 客户发起的。
### 邮件发送协议SMTP
SMTP（Simple Mail Transfer Protocol）所规定的就是在两个相互通信的 SMTP 进程之间应如何交换信息。

由于 SMTP 使用**客户服务器**方式，因此负责发送邮件的 SMTP 进程就是 SMTP 客户，而负责接收邮件的 SMTP 进程就是 SMTP 服务器。

SMTP 通信的三个阶段：
1. 连接建立：连接是在发送主机的 SMTP 客户和接收主机的SMTP 服务器之间建立的。SMTP不使用中间的邮件服务器。  
2. 邮件传送
3. 连接释放：邮件发送完毕后，SMTP 应释放TCP 连接。
### 邮件接收协议POP和IMAP
POP（Post Office Protocol）邮局协议是一个非常简单、但功能有限的邮件读取协议。现在使用的是它的第三个版本POP3。

**POP也使用客户服务器的工作方式**。在接收邮件的用户PC机中必须运行POP客户程序，而在用户所连接的ISP的邮件服务器中则运行 POP服务器程序。  

POP协议支持离线邮件处理，**当邮件发送到服务器后，电子邮件客户端会调用邮件客户端程序，下载所有未阅读的电子邮件（这种离线访问模式是一种存储转发服务）。当邮件从邮件服务器发送到个人计算机上，同时邮件服务器会删除该邮件**（但是目前很多POP3服务器都支持“下载邮件，服务器并不删除邮件”，也就是说在POP3中改进了POP协议）。

 
另一个读取邮件的协议是IMAP（InternetMessage Access Protocol），它比POP协议复杂很多。

**IMAP 也是按客户服务器方式工作**，现在较新的是版本 4，即 IMAP4。

用户在自己的 PC 机上就可以操纵邮件服务器的邮箱，就像在本地操纵一样。**IMAP最大的好处就是用户可以在不同的地方使用不同的计算机随时上网阅读和处理自己的邮件**。

 
注意，不要将邮件读取协议 POP 或 IMAP 与邮件传送协议 SMTP 弄混。发信人的用户代理向源邮件服务器发送邮件，以及源邮件服务器向目的邮件服务器发送邮件，都是使用 SMTP 协议。而 POP 协议或 IMAP 协议则是用户从目的邮件服务器上读取邮件所使用的协议。

### 基于万维网的电子邮件
现在我们大多数情况下都是使用基于万维网的电子邮件，outlook之类的用户代理客户端已经渐渐退出了市场。

不管在什么地方，只要能够上网，就可以借助浏览器收发电子邮件。这时，邮件系统中的用户代理就是普通的万维网浏览器。

需要注意的是，**浏览器从邮件服务器读取邮件，或者向邮件服务器发送邮件使用的是HTTP协议，而不是IMAP（POP）或SMTP**。

例如，一个网易邮箱用户向新浪邮箱用户通过浏览器发送邮件，各阶段使用的协议如下：
![基于万维网的邮件](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/%E5%9F%BA%E4%BA%8E%E4%B8%87%E7%BB%B4%E7%BD%91%E7%9A%84%E7%94%B5%E5%AD%90%E9%82%AE%E4%BB%B6%E5%8D%8F%E8%AE%AE.png)
## 常用端口
![常用端口](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/%E5%B8%B8%E7%94%A8%E7%AB%AF%E5%8F%A3.png)
## Web页面请求过程
### 1.DHCP配置主机信息
假设主机最开始没有 IP 地址以及其它信息，那么就需要先使用DHCP 来获取。
- 主机生成一个 DHCP 请求报文，并将这个报文放入具有目的端口 67 和源端口 68 的 UDP 报文段中。
- 该报文段则被放入在一个具有广播 IP 目的地址(255.255.255.255) 和源 IP 地址（0.0.0.0）的 IP 数据报中。
- 该数据报则被放置在 MAC 帧中，该帧具有目的地址 FF:FF:FF:FF:FF:FF，将广播到与交换机连接的所有设备。
- 连接在交换机的 DHCP 服务器收到广播帧之后，不断地向上分解得到 IP 数据报、UDP 报文段、DHCP 请求报文，之后生成 DHCP ACK 报文，该报文包含以下信息：IP 地址、DNS 服务器的 IP 地址、默认网关路由器的 IP 地址和子网掩码。该报文被放入 UDP 报文段中，UDP 报文段有被放入 IP 数据报中，最后放入 MAC 帧中。
- 该帧的目的地址是请求主机的 MAC 地址，因为交换机具有自学习能力，之前主机发送了广播帧之后就记录了 MAC 地址到其转发接口的交换表项，因此现在交换机就可以直接知道应该向哪个接口发送该帧。

- 主机收到该帧后，不断分解得到 DHCP 报文。之后就配置它的 IP 地址、子网掩码和 DNS 服务器的 IP 地址，并在其 IP 转发表中安装默认网关。
### 2.DNS和ARP
现在我们输入网址www.google.com回车会发生一系列事件，
- 主机通过浏览器生成一个 TCP 套接字，套接字向HTTP服务器发送 HTTP 请求。为了生成该套接字，主机需要知道网站的域名对应的IP地址。

- 主机生成一个DNS查询报文，该报文具有53号端口，因为DNS服务器的端口号是 53。

- 该 DNS 查询报文被放入目的地址为 DNS 服务器 IP 地址的 IP 数据报中。

- 该 IP 数据报被放入一个以太网帧中，该帧将发送到网关路由器。

- DHCP 过程只知道网关路由器的IP地址，为了获取网关路由器的 MAC 地址，需要使用 ARP 协议。

- 主机生成一个包含目的地址为网关路由器 IP 地址的 ARP 查询报文，将该 ARP 查询报文放入一个具有广播目的地址（FF:FF:FF:FF:FF:FF）的以太网帧中，并向交换机发送该以太网帧，交换机将该帧转发给所有的连接设备，包括网关路由器。

- 网关路由器接收到该帧后，不断向上分解得到 ARP 报文，发现其中的IP地址与其接口的IP地址匹配，因此就发送一个ARP回答报文，包含了它的 MAC 地址，发回给主机。
### 3.域内路由选择到DNS服务器
- 知道了网关路由器的 MAC 地址之后，就可以继续 DNS 的解析过程了。

- 网关路由器接收到包含 DNS 查询报文的以太网帧后，抽取出 IP 数据报，并根据转发表决定该 IP 数据报应该转发的路由器。

- 因为路由器具有内部网关协议（RIP、OSPF）和外部网关协议（BGP）这两种路由选择协议，因此路由表中已经配置了网关路由器到达 DNS 服务器的路由表项。

- 到达 DNS 服务器之后，DNS 服务器抽取出 DNS 查询报文，并在 DNS 数据库中查找待解析的域名。

- 找到 DNS 记录之后，发送 DNS 回答报文，将该回答报文放入 UDP 报文段中，然后放入 IP 数据报中，通过路由器反向转发回网关路由器，并经过以太网交换机到达主机。
### 4.HTTP请求页面
- 有了 HTTP 服务器的 IP 地址之后，主机就能够生成 TCP 套接字，该套接字将用于向 Web 服务器发送 HTTP GET 报文。

- 在生成 TCP 套接字之前，必须先与 HTTP 服务器进行三次握手来建立连接。生成一个具有目的端口 80 的 TCP SYN 报文段，并向 HTTP 服务器发送该报文段。

- HTTP 服务器收到该报文段之后，生成 TCP SYN ACK 报文段，发回给主机。

- 连接建立之后，浏览器生成 HTTP GET 报文，并交付给 HTTP 服务器。

- HTTP 服务器从 TCP 套接字读取 HTTP GET 报文，生成一个 HTTP 响应报文，将 Web 页面内容放入报文主体中，发回给主机。

- 浏览器收到 HTTP 响应报文后，抽取出 Web 页面内容，之后进行渲染，显示 Web 页面。