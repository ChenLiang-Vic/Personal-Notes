## 链路层提供的服务
### 1.封装成帧
所有在因特网上传送的数据都是以IP数据报为传送单位的，网络层的IP数据报传送到数据链路层就成为帧的数据部分，在帧的数据部分的前面和后面添加上首部和尾部，构成一个完整的帧。
![封装成帧](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/%E5%B0%81%E8%A3%85%E6%88%90%E5%B8%A7.png)  
图为RFC 1042和以太网的封装格式
其中CRC字段用于帧内后续字节差错的循环冗余码检验

**最大传送单元(MTU)**(Maximum Transfer Unit)：每一种链路层协议都规定了帧的数据部分的长度上限。比如上图中以太网数据帧的长度最大值分别是1500字节。  

**路径MTU**:如果两台主机之间的通信要通过多个网络，那么每个网络的链路层就可能有不同的MTU。重要的不是两台主机所在网络的MTU的值，重要的是**两台通信主机路径中的最小MTU**。它被称作路径MTU。
注意：从A到B的路由可能与从B到A的路由不同，因此路径MTU在两个方向上不一定是一致的

### 2.透明传输
透明传输，即无论什么样的比特流都能够通过数据链路层传输。

帧使用首部和尾部进行定界，如果帧的数据部分含有和首部尾部相同的内容，那么帧的开始和结束位置就会被错误的判定。

解决这种矛盾的方法是，将数据中可能出现的控制字符的前面插入转义字符“ESC”，而在接收端再删除该转义字符，这种方法被称为字节填充。这个过程透明传输的内容是转义字符，用户察觉不到转义字符的存在。
![透明传输](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/%E9%80%8F%E6%98%8E%E4%BC%A0%E8%BE%93.png) 
### 3.差错检测
现实的通信线路都不会是理想的，比特在传输过程中可能会产生差错：1可能会变成0，0也可能会变成1。为了保证数据传输的可靠性，必须采用各种差错检测措施。目前在数据链路层广泛使用的是**循环冗余检验CRC**（Cyclic Redundancy Check）

---
## 信道分类
### 点对点信道
**一对一通信**

因为不会发生碰撞，因此也比较简单，**使用 PPP(Point-to-PointProtocol)协议进行控制**。
### 广播信道
**一对多通信**  一个节点发送的数据能够被广播信道上所有的节点接收到。以太网和无线局域网就是一个很好的例子

所有的节点都在同一个广播信道上发送数据，因此需要有专门的控制方法进行协调，避免发生冲突（冲突也叫碰撞）。

主要有两种控制方法进行协调，一个是**使用信道复用技术**，一是**使用 CSMA/CD（载波监听多点接入/碰撞检测）协议**。

#### PPP协议
我们知道，因特网用户通常都要连接到某个ISP才能接入到因特网。PPP协议就是用户计算机和ISP进行通信时所使用的数据链路层协议。


PPP协议由三个部分组成：  
（1）一个将IP数据报封装到串行链路的方法。  
（2）一个用来建立、配置和测试数据链路连接的链路控制协议LCP（Link Control Protocol）。  
（3）一套网络控制协议NCP（Network Control Protocol）。

当用户拨号接入ISP后，就建立了一条从用户PC机到ISP的物理连接。这时，用户PC机向ISP发送一系列的LCP分组（封装成多个PPP帧），以便建立LCP连接。这些分组及其响应选择了将要使用的一些PPP参数。接着还要进行网络层配置，NCP给新接入的用户PC机分配一个临时的IP地址。这样，用户PC机就成为一个拥有IP地址的主机了。

当用户通信完毕时，NCP释放网络层连接，收回原来分配出去的IP地址。接着，LCP释放数据链路层连接。最后释放的是物理层的连接。

#### CSMA/CD协议
CSMA/CD 表示载波监听多点接入 / 碰撞检测。

- **多点接入** ：说明这是总线型网络，许多主机以多点的方式连接到总线上。
- **载波监听** ：每个主机都必须不停地监听信道。在发送前，如果监听到信道正在使用，就必须等待。
- **碰撞检测** ：在发送中，如果监听到信道已有其它主机正在发送数据，就表示发生了碰撞。虽然每个主机在发送数据之前都已经监听到信道为空闲，但是由于电磁波的传播时延的存在，还是有可能会发生碰撞。

记端到端的传播时延为 τ，最先发送的站点最多经过 2τ 就可以知道是否发生了碰撞，称2τ为**争用期** 。只有经过争用期之后还没有检测到碰撞，才能肯定这次发送不会发生碰撞。

当发生碰撞时，站点要停止发送，等待一段时间再发送。这个时间采用**截断二进制指数退避算法**来确定。从离散的整数集合 {0, 1, .., (2k-1)} 中随机取出一个数，记作 r，然后取r倍的争用期作为重传等待时间。

#### 信道复用技术
1. 频分复用：所有主机在相同的时间占用不同的频率带宽资源
![频分复用](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/%E9%A2%91%E5%88%86%E5%A4%8D%E7%94%A8.png)
2. 时分复用：所有主机在不同的时间占用相同的频率带宽资源
![时分复用](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/%E6%97%B6%E5%88%86%E5%A4%8D%E7%94%A8.png)
3. 统计时分复用：是对时分复用的一种改进，不固定每个用户在时分复用帧中的位置，只要有数据就集中起来组成统计时分复用帧然后发送
![统计时分复用](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/%E7%BB%9F%E8%AE%A1%E6%97%B6%E5%88%86%E5%A4%8D%E7%94%A8.png)

-----
### 局域网
局域网主要特点是网络为一个单位所拥有，且地理范围和站点数目均有限。

局域网具有广播功能，从一个站点可很方便地访问全网，局域网上的主机可共享连接在局域网上的各种硬件和软件资源。

局域网主要有以太网、令牌环网、FDDI 和 ATM 等局域网技术，目前以太网占领着有线局域网市场。

按照网络拓扑结构对局域网进行分类：  
![局域网分类](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/%E5%B1%80%E5%9F%9F%E7%BD%91.png)
### 以太网
以太网是一种星型拓扑结构局域网，在局域网市场中已取得了垄断地位，并且几乎成了局域网的代名词。

计算机与外界局域网的连接是通过**适配器**。适配器上装有处理器和存储器，适配器和局域网之间的通信是通过电缆或双绞线以串行传输方式进行的，而适配器和计算机之间的通信则是通过计算机主板上的I/O总线以并行传输方式进行的。因此，**适配器的一个重要功能就是要进行数据串行传输和并行传输的转换**。

适配器接受和发送各种帧时不使用计算机的CPU。当适配器收到正确的帧时，它就使用中断来通知该计算机并交付给协议栈中的网络层；当计算机要发送IP数据报时，就由协议栈把IP数据报向下交给适配器，组装成帧后发送到局域网。

需要注意，计算机的硬件地址就在适配器的ROM中，而计算机的IP地址则在计算机的存储器中。
![适配器](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/%E9%80%82%E9%85%8D%E5%99%A8.png)
### MAC地址
MAC 地址是链路层地址，长度为 6 字节（48位），**用于唯一标识网络适配器（网卡）**。

IEEE 的注册管理机构 RA 负责向厂家分配地址字段的前三个字节(即高位 24 位)。地址字段中的后三个字节(即低位 24 位)由厂家自行指派，称为扩展标识符，必须保证生产出的适配器没有重复地址。

一台主机拥有多少个网络适配器就有多少个 MAC 地址。例如笔记本电脑普遍存在无线网络适配器和有线网络适配器，因此就有两个 MAC 地址。

适配器有过滤功能，适配器从网络上每收到一个MAC帧就先用硬件检查MAC帧中的目的地址，如果是发往本站的帧则收下，否则丢弃。发往本站的帧包括以下三种帧：

（1）单播帧，即收到的帧的MAC地址与本站的硬件地址相同。
（2）广播帧，即发送给本局域网上所有站点的帧。
（3）多播帧，即发送给本局域网上一部分站点的帧。

![MAC帧格式](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/MAC%E5%B8%A7%E6%A0%BC%E5%BC%8F.png)
如上图所示，MAC地址由五个字段组成。前两个字段为目的地址和源地址。第三个字段是类型字段，用来标识上一层使用的是什么协议，以便把收到的MAC帧的数据上交给上一层的这个协议。第四个字段是数据字段，最后一个是帧检验序列FCS（使用CRC检验）。
## 局域网的扩展
### 集线器
使用集线器（hub）可以**在物理层扩展局域网**

集线器是一种物理层设备， 作用于比特而不是帧，当一个比特到达接口时，集线器重新生成这个比特，并将其能量强度放大，从而扩大网络的传输距离，之后再将这个比特发送到其它所有接口。如果集线器同时收到两个不同接口的帧，那么就发生了碰撞。  

![集线器](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/%E9%9B%86%E7%BA%BF%E5%99%A8.png)

- 优点：
  - 使原来属于不同碰撞域的局域网上的计算机能够进行跨碰撞域的通信。
  - 扩大了局域网覆盖的地理范围。
- 缺点
  - 碰撞域增大了，但总的吞吐量并未提高。
  - 如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互连起来。  

### 网桥
**在数据链路层扩展局域网是使用网桥**(network bridge)。

网桥工作在数据链路层，它根据MAC帧的目的地址对收到的帧进行转发。

网桥具有过滤帧的功能。当网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的MAC地址，然后再确定将该帧转发到哪一个接口。  

![网桥](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/%E7%BD%91%E6%A1%A5.png)

- 优点
  - 过滤通信量。
  - 扩大了物理范围。
  - 提高了可靠性。
  - 可互连不同物理层、不同 MAC 子层和不同速率（如10Mb/s 和 100 Mb/s 以太网）的局域网
- 缺点
  - 存储转发增加了时延。
  - 在MAC子层并没有流量控制功能。
  - 具有不同 MAC 子层的网段桥接在一起时时延更大。

网桥只适合于用户数不太多(不超过几百个)和通信量不太大的局域网，否则有时还会因传播过多的广播信息而产生网络拥塞。这就是所谓的**广播风暴**。
 
### 交换机
目前以太网主要使用交换机，交换机是一种链路层设备，它不会发生碰撞，能根据 MAC 地址进行存储转发

以太网交换机通常都有十几个接口。因此，**以太网交换机实质上就是一个多接口的网桥，可见交换机工作在数据链路层**。  

![交换机](https://github.com/ChenLiang-Vic/Personal-notes/blob/master/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/img/%E4%BA%A4%E6%8D%A2%E6%9C%BA.png)

对于普通 10 Mb/s 的共享式以太网，若共有 N个用户，则每个用户占有的平均带宽只有总带宽(10 Mb/s)的 N 分之一。

使用以太网交换机时，虽然在每个接口到主机的带宽还是 10 Mb/s，但由于一个用户在通信时是独占而不是和其他网络用户共享传输媒体的带宽，因此对于拥有 N 对接口的交换机的总容量为 N10 Mb/s。这正是交换机的最大优点。 

## 虚拟局域网
虚拟局域网（Virtual Local Area Network，VLAN）是一组逻辑上的设备和用户，通过端口分配、MAC地址分配等方式将同一局域网内的主机划分为不同的区域（VLAN），不同区域之间的主机无法直接通信（即使它们都在同一个有线局域网中），而同一区域内的主机之间可以正常通信，这就好像一个局域网一样，因此叫做虚拟局域网。

与传统局域网相比优点：
   - 网络设备的移动、添加和修改的管理开销减少
   - 可以控制广播活动
   - 可以提高网络的安全性

完全隔离的两个VLAN如何通信？  
使用**VLAN干线连接**来建立虚拟局域网，每台交换机上的一个特殊接口被设置为干线接口，以互连VLAN 交换机。该干线端口属于所有VLAN，发送到任何VLAN的帧经过干线链路转发到其他交换机。  
交换机如何区别到达干线端口的帧属于哪个VLAN？  
IEEE 定义了一种扩展的以太网帧格式 802.1Q，它在标准以太网帧上加进了4字节首部**VLAN标签**，用于表示该帧属于哪一个虚拟局域网。